- name: Install Apache APISIX on Kubernetes
  hosts: localhost
  gather_facts: yes
  tasks:

    - name: Install Helm if not present
      shell: |
        if ! command -v helm &> /dev/null; then
          curl -LO https://get.helm.sh/helm-v3.17.1-linux-amd64.tar.gz
          tar -zxvf helm-v3.17.1-linux-amd64.tar.gz
          mv linux-amd64/helm /usr/local/bin/helm
          chmod +x /usr/local/bin/helm
          rm -rf linux-amd64 helm-v3.17.1-linux-amd64.tar.gz
          echo 'export PATH="/usr/local/bin:$PATH"' >> ~/.bashrc
        fi
      args:
        executable: /bin/bash

    - name: Verify Helm installation
      command: /usr/local/bin/helm version
      register: helm_version
      changed_when: false

    - name: Show Helm version
      debug:
        msg: "{{ helm_version.stdout }}"

    - name: Add APISIX Helm repo
      command: /usr/local/bin/helm repo add apisix https://charts.apiseven.com
      changed_when: false

    - name: Update Helm repo
      command: /usr/local/bin/helm repo update
      changed_when: false

    - name: Deploy APISIX using Helm
      command: /usr/local/bin/helm install apisix apisix/apisix --namespace apisix --create-namespace
      register: helm_output

    - name: Display Helm install output
      debug:
        msg: "{{ helm_output.stdout }}"
