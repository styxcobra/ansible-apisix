- name: Install Apache APISIX on Kubernetes
  hosts: localhost
  gather_facts: yes
  tasks:

    # ğŸ”¹ ç¡®ä¿ Helm å®‰è£…ï¼ˆé€‚ç”¨äº AWX ä»»åŠ¡å®¹å™¨ï¼‰
    - name: Install Helm if not present
      shell: |
        if ! command -v helm &> /dev/null; then
          curl -LO https://get.helm.sh/helm-v3.17.1-linux-amd64.tar.gz
          tar -zxvf helm-v3.17.1-linux-amd64.tar.gz
          mv linux-amd64/helm /usr/local/bin/helm
          chmod +x /usr/local/bin/helm
          rm -rf linux-amd64 helm-v3.17.1-linux-amd64.tar.gz
        fi
      args:
        executable: /bin/bash

    # ğŸ”¹ è·³è¿‡ macOS ç›¸å…³æ­¥éª¤ï¼ˆAWX è¿è¡Œåœ¨ Linux å®¹å™¨é‡Œï¼Œä¸éœ€è¦ Homebrewï¼‰

    # ğŸ”¹ ç¡®ä¿ Helm repo å­˜åœ¨
    - name: Add APISIX Helm repo
      command: helm repo add apisix https://charts.apiseven.com
      changed_when: false

    - name: Update Helm repo
      command: helm repo update
      changed_when: false

    # ğŸ”¹ éƒ¨ç½² APISIX
    - name: Deploy APISIX using Helm
      command: helm install apisix apisix/apisix --namespace apisix --create-namespace
      register: helm_output

    - name: Display Helm install output
      debug:
        msg: "{{ helm_output.stdout }}"

    # ğŸ”¹ ç¡®ä¿ APISIX è¿è¡Œ
    - name: Ensure APISIX is running in Kubernetes
      shell: kubectl get pods -n apisix
      register: k8s_status
      until: "'Running' in k8s_status.stdout"
      retries: 5
      delay: 10

    # ğŸ”¹ ç«¯å£è½¬å‘ï¼ˆä»…é€‚ç”¨äºæœ¬åœ°ç¯å¢ƒï¼‰
    - name: Expose APISIX service for local access
      shell: kubectl port-forward --namespace apisix svc/apisix-gateway 9080:80 &
